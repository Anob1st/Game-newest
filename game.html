<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawing Room</title>
<style>
body { margin:0; font-family: Arial; display:flex; flex-direction:column; align-items:center; background:#f8f8f8;}
#topbar { display:flex; gap:10px; margin:10px;}
canvas { border:2px solid #000; margin-top:10px; background:white;}
#players { display:flex; gap:10px; margin-top:10px; }
.player { display:flex; flex-direction:column; align-items:center; font-size:14px;}
button { padding:5px 10px; font-size:14px; margin:3px;}
#tools { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;}
#chat { margin-top:10px; width:800px; max-width:90%; display:flex; gap:5px;}
#chatMessages { flex:1; border:1px solid #aaa; padding:5px; height:100px; overflow-y:auto; background:#fff;}
</style>
</head>
<body>

<div id="topbar">
  <div id="players"></div>
</div>

<canvas id="canvas" width="800" height="600"></canvas>

<div id="tools">
  <button id="undo">Undo</button>
  <button id="clear">Clear</button>
  <input type="color" id="color" value="#000000">
  <input type="range" id="brush" min="1" max="10" value="3">
</div>

<div id="chat">
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Type message">
  <button id="sendChat">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, doc, getDoc, onSnapshot, updateDoc, arrayUnion, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDyOnvm0qMvREjKgn12gN5QEml_AmodiRo",
    authDomain: "oooooo-ca089.firebaseapp.com",
    projectId: "oooooo-ca089",
    storageBucket: "oooooo-ca089.firebasestorage.app",
    messagingSenderId: "351774678518",
    appId: "1:351774678518:web:18511398dec45ece047bd7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Get player info ---
const playerName = localStorage.getItem("playerName");
const avatar = localStorage.getItem("avatar");
const roomCode = localStorage.getItem("roomCode");

// --- UI: players ---
const playersDiv = document.getElementById("players");
const roomRef = doc(db,"rooms",roomCode);

function updatePlayersUI(players){
  playersDiv.innerHTML = "";
  players.forEach(p=>{
    const div = document.createElement("div");
    div.className="player";
    div.innerHTML=`<img src="${p.avatar}" width="50"><span>${p.name}</span>`;
    playersDiv.appendChild(div);
  });
}

// realtime listener
onSnapshot(roomRef, snap=>{
  const data = snap.data();
  if(data && data.players) updatePlayersUI(data.players);
});

// --- Canvas setup ---
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing = false;
let lastX=0, lastY=0;
let brushColor = document.getElementById("color").value;
let brushSize = document.getElementById("brush").value;

document.getElementById("color").addEventListener("input", e=>brushColor=e.target.value);
document.getElementById("brush").addEventListener("input", e=>brushSize=e.target.value);

canvas.addEventListener("mousedown", e=>{
  drawing=true;
  lastX=e.offsetX; lastY=e.offsetY;
});
canvas.addEventListener("mouseup", e=>drawing=false);
canvas.addEventListener("mouseout", e=>drawing=false);
canvas.addEventListener("mousemove", draw);

function draw(e){
  if(!drawing) return;
  const x=e.offsetX, y=e.offsetY;
  ctx.strokeStyle=brushColor;
  ctx.lineWidth=brushSize;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(lastX,lastY);
  ctx.lineTo(x,y);
  ctx.stroke();
  lastX=x; lastY=y;
  // Send stroke to Firestore
  const stroke = {x1:lastX, y1:lastY, x2:x, y2:y, color:brushColor, size:brushSize, name:playerName};
  updateDoc(roomRef, { strokes: arrayUnion(stroke) }).catch(()=>{});
}

// --- Undo & Clear ---
document.getElementById("undo").addEventListener("click", async ()=>{
  const snap = await getDoc(roomRef);
  const data = snap.data();
  if(!data || !data.strokes) return;
  const strokes = data.strokes.filter(s=>s.name
