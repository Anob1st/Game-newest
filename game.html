<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplayer Drawing Game</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; }
  canvas { border: 2px solid #333; margin: 10px; background: white; }
  .controls { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
  .controls input, .controls button { margin: 5px; padding: 8px; font-size: 14px; }
  .players { display: flex; justify-content: center; margin-bottom: 10px; }
  .players img { width: 50px; margin: 5px; border-radius: 10px; }
  .chat { border: 1px solid #999; width: 400px; height: 120px; overflow-y: auto; margin-bottom: 5px; padding:5px; }
</style>
</head>
<body>

<h2>Room: <span id="roomIdDisplay"></span></h2>

<canvas id="canvas" width="800" height="600"></canvas>

<div class="controls">
  <input type="color" id="colorPicker" value="#000000">
  <input type="range" id="brushSize" min="1" max="20" value="5">
  <button id="undoBtn">Undo</button>
  <button id="clearBtn">Clear</button>
</div>

<div class="players" id="playersDiv"></div>

<div class="chat" id="chatDiv"></div>
<input type="text" id="guessInput" placeholder="Type your guess">
<button id="sendGuessBtn">Send</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, doc, setDoc, updateDoc, arrayUnion, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDyOnvm0qMvREjKgn12gN5QEml_AmodiRo",
  authDomain: "oooooo-ca089.firebaseapp.com",
  projectId: "oooooo-ca089",
  storageBucket: "oooooo-ca089.firebasestorage.app",
  messagingSenderId: "351774678518",
  appId: "1:351774678518:web:18511398dec45ece047bd7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
await signInAnonymously(auth);
const db = getFirestore(app);

// Parse URL params
const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get("room");
const uid = urlParams.get("uid");
document.getElementById("roomIdDisplay").textContent = roomId;

// Firestore reference
const roomRef = doc(db, "rooms", roomId);

// Canvas setup
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let drawing = false;
let strokes = [];
let currentStroke = null;

const colorPicker = document.getElementById("colorPicker");
const brushSizeInput = document.getElementById("brushSize");
const undoBtn = document.getElementById("undoBtn");
const clearBtn = document.getElementById("clearBtn");

canvas.addEventListener("pointerdown", e => {
  drawing = true;
  const size = brushSizeInput.value;
  currentStroke = { uid, color: colorPicker.value, size: size, points: [{x:e.offsetX, y:e.offsetY}] };
});

canvas.addEventListener("pointermove", e => {
  if (!drawing) return;
  const last = currentStroke.points[currentStroke.points.length -1];
  const newPoint = { x:e.offsetX, y:e.offsetY };
  currentStroke.points.push(newPoint);

  // Slight fast thin / slow thick effect
  const dist = Math.hypot(newPoint.x - last.x, newPoint.y - last.y);
  ctx.strokeStyle = currentStroke.color;
  ctx.lineWidth = Math.max(1, Math.min(30, size/dist*2));
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(last.x,last.y);
  ctx.lineTo(newPoint.x,newPoint.y);
  ctx.stroke();
});

canvas.addEventListener("pointerup", async e => {
  if (!drawing) return;
  drawing = false;
  strokes.push(currentStroke);
  await updateDoc(roomRef, { canvasStrokes: arrayUnion(currentStroke) });
  currentStroke = null;
});

// Undo
undoBtn.addEventListener("click", async () => {
  strokes.pop();
  await updateDoc(roomRef, { canvasStrokes: strokes });
});

// Clear
clearBtn.addEventListener("click", async () => {
  strokes = [];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  await updateDoc(roomRef, { canvasStrokes: [] });
});

// Listen for Firestore updates
onSnapshot(roomRef, snapshot => {
  const roomData = snapshot.data();

  // Update players
  const playersDiv = document.getElementById("playersDiv");
  playersDiv.innerHTML = "";
  roomData.players.forEach(p => {
    const img = document.createElement("img");
    img.src = p.avatar || "avatar1.png";
    img.title = p.name;
    playersDiv.appendChild(img);
  });

  // Redraw canvas
  ctx.clearRect(0,0,canvas.width,canvas.height);
  strokes = roomData.canvasStrokes || [];
  strokes.forEach(s => {
    ctx.strokeStyle = s.color;
    ctx.lineWidth = s.size;
    ctx.lineCap = "round";
    ctx.beginPath();
    s.points.forEach((pt,i) => {
      if(i==0) ctx.moveTo(pt.x, pt.y);
      else ctx.lineTo(pt.x, pt.y);
    });
    ctx.stroke();
  });

  // Update chat
  const chatDiv = document.getElementById("chatDiv");
  chatDiv.innerHTML = "";
  (roomData.guesses || []).forEach(g => {
    const p = document.createElement("div");
    p.textContent = `${g.name}: ${g.text}`;
    chatDiv.appendChild(p);
  });
});

// Chat input
const guessInput = document.getElementById("guessInput");
const sendGuessBtn = document.getElementById("sendGuessBtn");
sendGuessBtn.addEventListener("click", async () => {
  const text = guessInput.value.trim();
  if(!text) return;
  const roomSnap = await getDoc(roomRef);
  const roomData = roomSnap.data();
  const player = roomData.players.find(p => p.uid === uid);
  await updateDoc(roomRef, { guesses: arrayUnion({ uid, name: player.name, text }) });
  guessInput.value = "";
});

</script>
</body>
</html>